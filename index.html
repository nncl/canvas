<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>CAOA</title>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&display=swap"
          rel="stylesheet">

    <style>
        html,
        body {
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
<canvas id="myCanvas" width="900" height="900"></canvas>

<form onsubmit="create(event)" method="POST">
    <input type="text" name="username" placeholder="Username">
    <input type="text" name="job" placeholder="Job">
    <input type="tel" name="phone" placeholder="Phone">
    <input type="email" name="email" placeholder="E-mail">
    <input type="file" name="thumb">

    <button>
        Create
    </button>
</form>

<script>
    function createImage(
        username,
        job,
        phone,
        email,
        thumb
    ) {
        var canvas = document.getElementById("myCanvas");
        var context = canvas.getContext("2d");
        var imageObj = new Image();

        imageObj.onload = function () {
            context.drawImage(imageObj, 0, 0);

            context.font = "normal normal bold 39.5px Roboto Condensed";
            context.fillStyle = "#FFFFFF";
            context.fillText(username, 218.1, 825);

            context.font = "normal normal 400 23px Roboto Condensed";
            context.fillStyle = "#00C28A";
            context.fillText(job, 218.1, 850);

            context.font = "normal normal 400 27px Roboto Condensed";
            context.fillStyle = "#FFFFFF";
            context.fillText(phone, 533.1, 820);

            context.font = "normal normal 400 23px Roboto Condensed";
            context.fillStyle = "#FFFFFF";
            context.fillText(email, 533.1, 849.5);

            /**
             * Create rounded user thumb
             * @type {HTMLImageElement}
             */
            var imageUser = new Image();
            imageUser.onload = function () {
                /**
                 * Fake canvas
                 * @type {HTMLCanvasElement}
                 */

                var scratchCanvas = document.createElement('canvas');
                scratchCanvas.width = 176;
                scratchCanvas.height = 176;
                var scratchCtx = scratchCanvas.getContext('2d');

                scratchCtx.clearRect(0, 0, scratchCanvas.width, scratchCanvas.height);
                scratchCtx.globalCompositeOperation = 'source-over'; // default
                scratchCtx.drawImage(imageUser, 0, 0);

                scratchCtx.fillStyle = '#fff'; // color doesn't matter, but we want full opacity
                scratchCtx.globalCompositeOperation = 'destination-in';
                scratchCtx.beginPath();
                scratchCtx.arc(88, 88, 86.5, 0, 2 * Math.PI, true);
                scratchCtx.closePath();
                scratchCtx.fill();

                context.drawImage(scratchCanvas, 7, 696.6);
            }
            // imageUser.src = "img/user.png";

            var reader = new FileReader();
            reader.onload = function (e) {
                imageUser.src = e.target.result;
            };
            reader.readAsDataURL(thumb);
        };
        imageObj.src = "img/bg.png";
    };

    // Thanks to https://stackoverflow.com/a/4729778/4495348

    function create(e) {
        e.preventDefault();

        var username = document.getElementsByName('username')[0].value;
        var job = document.getElementsByName('job')[0].value;
        var phone = document.getElementsByName('phone')[0].value;
        var email = document.getElementsByName('email')[0].value;
        var thumb = document.getElementsByName('thumb')[0].files[0];

        createImage(username, job, phone, email, thumb);
    }
</script>
</body>
</html>
